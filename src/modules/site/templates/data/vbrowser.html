{% extends "_layouts/default.html" %}


{% block custom_head %}
    <link rel="stylesheet" href="//cdn.datatables.net/1.10.24/css/jquery.dataTables.min.css" />
    <script type="text/javascript" src="//cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/colreorder/1.5.3/css/colReorder.dataTables.min.css" />
    <script type="text/javascript" src="https://cdn.datatables.net/colreorder/1.5.3/js/dataTables.colReorder.min.js"></script>
{% endblock %}


{% block style %}
<style>

table.dataTable thead .sorting_asc {
  background: url("//cdn.datatables.net/1.10.0/images/sort_asc.png") no-repeat center left;
}
table.dataTable thead .sorting_desc {
  background: url("//cdn.datatables.net/1.10.0/images/sort_desc.png") no-repeat center left;
}
table.dataTable thead .sorting {
  background: url("//cdn.datatables.net/1.10.0/images/sort_both.png") no-repeat center left;
}

mark {
  background-color: inherit;
  font-size: 0.8rem;
}

.hl-mark {
  background-color: yellow;
}


</style>
{% endblock %}

{% block content %}

<!-- <div class="container-fluid browser-row well"> -->
  <div class="browser-row well">

<div class="row">
      {# Gene Search Block #}
      <div class="col-lg-12">
        <div class="row">
      <div class="col-lg-4 col-lg-offset-0 col-md-10 col-md-offset-1 col-sm-8 col-sm-offset-2 col-xs-12 text-center">

        <h3><label for="gene-search"> Species </label></h3>
        <select name="species" id="species-selector" onchange="update_species()">
          {% for s in species_list %}
            <option value="{{s}}">{{species_list[s]["short_name"]}}</option>
          {% endfor %}
        </select>

        <br /><br />

        <h3><label for="gene-search"> Gene </label></h3>
        <form id='form-submit-gene' method='post'>
          <div class="form-group">
            <input name="gene-search" id="gene-search" class="form-control text-center" placeholder="isw-1">
          </div>
        </form>
        <small id="gene-search-label">Search by WBGeneID, alphanumeric name (F37A4.8), or gene name (isw-1)</small>
        <div id="loading-search-table" style="display:none; margin-top:20px; ">
          <div class="spinner">
            <div class="bounce1"></div>
            <div class="bounce2"></div>
            <div class="bounce3"></div>
          </div>
        </div>

        <table id="v-search-table" class='table table-striped' style="display:none; table-layout:fixed;">
          <thead>
            <tr>
              <th>Gene</th>
              <th>Name</th>
              <th>ID</th>
            </tr>
          </thead>
          <tbody id="orthologs"></tbody>
        </table>

      </div> {# /col-lg-4 #}
      

      {# Interval Search Block #}
      <div class="col-lg-4 col-lg-offset-0 col-md-10 col-md-offset-1 col-sm-8 col-sm-offset-2 col-xs-12 text-center">
        <h3><label for="interval"> Interval </label></h3>
        <form id='form-submit-interval' method='post'>
          <div class="form-group">
            <input name="interval" id="interval" class="form-control text-center" placeholder="III:11,746,923-11,750,250" pattern="(I|II|III|IV|V|X|MtDNA):[0-9,]+-[0-9,]+">
          </div>
          <small>Search using the format [chromosome:START-STOP]</small>
          <div class="btn-mid-row" style="width: 60%; margin: auto;">
            <button class="btn nu-alt-btn btn-block" id="search-interval-btn">
              <span class="glyphicon glyphicon-ok" aria-hidden="true"></span> 
              Search
            </button>
          </div>
        </form>
        <div class="btn-mid-row" style="width: 60%; margin: auto;">
          <button class="btn nu-alt-btn btn-block" disabled id="download-result-btn" onClick="onDownload();">
            <span class="glyphicon glyphicon-download" aria-hidden="true"></span> 
            Download Results
          </button>
        </div>
        <div class="btn-bottom-row" style="width: 60%; margin: auto;">
          <a href="https://storage.googleapis.com/caendr-site-public-bucket/dataset_release/c_elegans/{{current_version}}/variation/WI.{{current_version}}.strain-annotation.tsv.gz"
              type="button" class="btn nu-alt-btn btn-block" id="download-all-btn"
            >
            <span class="glyphicon glyphicon-download" aria-hidden="true"></span>
            Download All Annotations
          </a>
        </div>
      </div> {# /col-lg-4 #}


  {# Column select list block #}
  <div class="col-lg-2 col-lg-offset-0 col-md-4 col-md-offset-2 col-sm-6 col-xs-6">
    <h3 class="text-center">Columns</h3>

    <div class="chk-select-list" id="col-select">
      <form>
        <div class="form-group">
          <div class="select-checkbox">
            <div class="col-entry">
              <input class="toggle-col-chk" type="checkbox" name="toggle_all_cols" id="toggle_all_cols"/>
              <strong><label id="toggle_all_cols_label" for="toggle_all_cols"> Select All </label> </strong>
            </div>
            <br>
          {% for col in columns %}
            <div class="col-entry">
              <input class="toggle-col-chk" type="checkbox" name="toggle_{{ col['id'] }}" id="toggle_{{ col['id'] }}" data-column="{{ col['id'] }}"/>
              <label for="toggle_{{ col['id'] }}"> {{ col['name'] }} </label>
            </div>
          {% endfor %}
          </div>
        </div>
      </form>
    </div> {# /col-list #}

    <button class="btn nu-alt-btn btn-block" id="reset-cols-btn" onClick="select_default_columns()">
      Reset Default Columns
    </button>
  </div> {# /col-md-2 #}

  {# strain select list block #}
  <div class="col-lg-2 col-md-4 col-sm-6 col-xs-6">
      <h3 class="text-center">Strains</h3>

      <div class="pre-scrollable chk-select-list sticky" id="strain-select">

        <input id="strain-filter" type="text" class="chk-select-filter" placeholder="Search" action="#" autocomplete="off">

        <form>
          <div class="form-group">
            <div class="select-checkbox">
              <div class="strain-entry select-searchable">
                <input class="toggle-strain-chk" type="checkbox" name="toggle_all_strains" id="toggle_all_strains" checked/>
                <strong><label id="toggle_all_strains_label" for="toggle_all_strains"> Select All </label></strong>
              </div>
              <br>
              {% for species in species_list %}
              <div id="strain-entry-container-{{species}}" class="strain-entry-container">
                {% for strain in strain_listing[species] %}
                <div class="strain-entry select-searchable">
                  <input class="toggle-strain-chk toggle-strain-chk-{{species}}" type="checkbox" data-column="{{strain}}" id="toggle_{{strain}}" checked/>
                  <label for="toggle_{{strain}}"> {{ strain }} </label>
                </div>
                {% endfor %}
              </div>
              {% endfor %}
            </div>
          </div>
        </form>
      </div> {# /strain-list #}
  </div> {# /col-md-2 #}
</div>{# /row #}

<div class="row">
  <div class="col-lg-4 col-lg-offset-8 col-sm-8 col-sm-offset-2 col-xs-12">

    <h3 class="text-center">Variant Impact</h3>

      <form class="form-inline impact-chk-group">
          <div class="row">

          <div class="col-xs-6 form-group text-center">
            <div class="impact-entry select-checkbox">
              <input class="toggle-impact-chk" type="checkbox" name="impact_high" id="impact_high" checked/>
              <strong><label id="impact_high_label" for="impact_high"> High </label> </strong>
            </div>
          </div> {# /form group #}

          <div class="col-xs-6 form-group text-center">
            <div class="impact-entry select-checkbox">
              <input class="toggle-impact-chk" type="checkbox" name="impact_low" id="impact_low"/>
              <strong><label id="impact_low_label" for="impact_low"> Low </label> </strong>
            </div>
          </div> {# /form group #}

        </div> {#/ row #}
      
      </form>

    </div> {# /col #}
</div> {# /row #}
</div> {# /col-lg-12 #}
</div> {# /row #}
</div> {# /container #}

<div class="row">
  <div class="col-lg-12">
    <div id="loading-variant-table" style="display:none; margin-top:20px;">
      <div class="spinner">
        <div class="bounce1"></div>
        <div class="bounce2"></div>
        <div class="bounce3"></div>
      </div>
    </div>

    <div id='result-table'>
      <table id='variant-table' class='table-striped table-hover table-compact'>
        <thead>
          <tr class="header">
        {% for col in columns %}
            <th class="data-{{col['id']}} sorting"><strong> {{ col['name'] }} </strong></th>
        {% endfor %}
          </tr>
        </thead>

        <tbody>
            <tr>
          {% for col in columns %}
              <td class="data-{{col['id']}}"> </td>
          {% endfor %}
            </tr>
        </tbody>
      </table>
    </div>
  </div> {# /col-lg-12 #}
</div> {# /row #}


{% endblock %}

{% block script %}
{% from "_includes/macros.html" import unpack_species_list %}
<script>


/* Variables */

const doneTypingInterval = 1000;  //time in ms (5 seconds)
const col_max_len = 20;
const strains_per_row = 10;

let typingTimer;                //timer identifier

let dTable = null;
const selected_strains = new Set();

// Initialize impact variables to match their checkboxes
let impactHigh = $("#impact_high").prop('checked');
let impactLow  = $("#impact_low").prop('checked');

let toggle_strain_lock = false;

let result_data = {};
let cachedTargets = {};

// Species dictionary & selected species
const species_list = {{ unpack_species_list(species_list, species_fields) }};
var species = null

const columnList = JSON.parse('{{ columns | tojson }}');

const strainListing = JSON.parse('{{ strain_listing | tojson }}');



/* Species */

// Track changes to selected species
function update_species() {

  // Get species from selector
  species_id = document.getElementById('species-selector').value;
  species    = species_list[species_id];

  // Reprocess gene search with the new species
  $("#loading-search-table").fadeIn();
  process_gene_search();

  // Update the strain list table
  update_strains();
}



/* Strains */

function update_strains() {

  // Show only strains matching current species
  $('.strain-entry-container').hide();
  $(`#strain-entry-container-${species_id}`).show();

  // Update selected strains set to match current species
  update_selected_strains();
}


function update_selected_strains() {

  // Clear selected strains
  selected_strains.clear();

  // Loop through each strain checkbox associated with the current species
  $(`.toggle-strain-chk-${species.name}`).each((i, obj) => {

    // If box is checked, add to strain set
    if (obj.checked) {
      selected_strains.add(obj.dataset.column);
    }
  });
}



/* CSV Download */

async function downloadCSV(json_data) {
  const csrfToken = "{{ form.csrf_token._value() }}";
  const url = "{{ url_for('variant_browser.vbrowser_download_csv') }}"
  const res = await fetch(url, {
    method: "POST",
    credentials: "include",
    body: json_data,
    cache: "no-cache",
    headers: new Headers({
        'Content-Type': 'application/json',
        'X-CSRF-TOKEN': csrfToken
    })
  });
  
  if (res.ok) {
    const buffer = await res.blob();
    const blob = new Blob([buffer], { type: 'text/csv' });
    const link = document.createElement("a");
    link.href = window.URL.createObjectURL(blob);
    const interval = $('#interval').val()
    link.download = `data_${interval}.csv`;
    link.click();
  } else {
    const err = await res.json()
    console.error(err.message)
    window.location.href = "{{ url_for('variant_browser.vbrowser', download_err=True ) }}"
  }

}

function onDownload() {
  const jsonData = JSON.stringify({ ...result_data });
  downloadCSV(jsonData);
}



/* Gene Search */

function process_gene_search() {
  $("#loading-search-table").fadeOut();
  let gene = $('#gene-search').val().trim();
  if (!gene.length) {
    $("#v-search-table").fadeOut();
  } else {
    $("#orthologs").html("");
    $.ajax({
         url: "{{ url_for('api_gene.api_search_genes', query='') }}" + gene + '?species=' + species.name,
         method: "GET",
         contentType: 'application/xml',
         }).done(function(results) {
          const genes = results.filter(result => !!result.chrom && !!result.start && !!result.end)
          genes.forEach(gene => {
            const position = gene["chrom"] + ":" + gene["start"] + "-" + gene["end"];
            const link = `<a onclick="set_position('${position}')" link='${position}' class='ortholink'>${gene['gene_id']}</a>`;
            const result = [
              gene['gene_symbol'],
              gene['sequence_name'],
              link,
            ]
            const table_data = "<tr><td>" + result.join("</td><td>").slice(0,-4) + "</tr>";
            $("#orthologs").append(table_data);
          });
          $("#v-search-table").fadeIn();
        });
  }
}

function set_position(pos) {
  $('#interval').val(pos);
  $('#search-interval-btn').click();
}

function toggleDisableForm(disabled = false) {
  // false = form enabled, true = form disabled
  $("#search-interval-btn").attr("disabled", disabled);
  $('#interval').attr("disabled", disabled);
}



/* Table Visibility */

function hideTable() {
  $("#result-table").fadeOut();
  $("#loading-variant-table").fadeIn();
}

function showTable() {
  $("#loading-variant-table").fadeOut();  
  $("#result-table").fadeIn();
}



/* Table Filtering */

function filter_rows_by_strains() {

  // Join all selected strains with RegEx 'or' operator, defaulting to empty expression to prevent matching everything
  var r = [...selected_strains].join('|') || '^$';

  // Hide the table while filtering
  hideTable();

  // Construct the filtered table
  // Note: Don't create a RegExp object, or fnFilter will only work if a '|' character is added to the front and end
  //       of the expression. Not sure why this happens...
  $('#variant-table').dataTable().fnFilter(r, 'strains:name', true, false);
  $('#variant-table').DataTable().draw();

  // If specific strains are selected, highlight them in the table
  highlight_selected_strains();

  // Show the table
  showTable();
}

function filter_rows_by_impact() {
    /* build regex from strain set and filter */
    let r = "Linker";
    if (impactHigh) {
      r += "|HIGH";
    } 
    if (impactLow) {
      r += "|LOW";
    }
    $('#variant-table').dataTable().fnFilter(r, 'variant_impact:name', true, false);
}




/* Result Table -- General Columns */


function chunk_substr(data, size) {
  if (typeof data === 'string' && data.length > col_max_len) {
    let numChunks = Math.ceil(data.length / size)
    let chunks = new Array(numChunks)
    for (let i = 0, o = 0; i < numChunks; ++i, o += size) {
      chunks[i] = data.substr(o, size)
    }
    return chunks.join('<br/>')
  } else {
    return data;
  }
}

function processCol(col, id) {
  if (id == 'strains') {
    return col
  }
  return chunk_substr(col, col_max_len)
}



/* Result Table -- Strains Column */

function highlight_selected_strains() {
  $("mark").removeClass('hl-mark');
  selected_strains.forEach(strain => {
    $(`.mark_${strain}`).addClass('hl-mark');
  });
}

function renderStrainsCol(data, type, row) {
  // let result = '<mark></mark>';
  let strains = data.split(',');

  // Map each strain to a mark tag
  let result = strains.map( (strain) => `<mark class="mark_${strain}">${strain}</mark>` )

  // Add a line break after every strains_per_row elements
  for (let i = strains_per_row; i < result.length; i += strains_per_row) {
    result[i] = "<br/>" + result[i];
  }

  // Concatenate result together with commas and return
  return result.join(', ');
}



/* Result Table -- Target Consequence Column */

function renderTargetConsequenceCol(data, type, row) {
  if (data) {
    return `<button class="btn-alt" onClick="expandTargetConsequence(this, ${data});"><span class='glyphicon glyphicon-collapse-down'></span>${data}</button>`;
  }
  return '';
}

function renderTargetConsequenceTable(data) {
  let result = "<div class='instruction-well'><table class='table table-striped table-condensed table-hover' style='width:80%;margin-left:10%;font-size:0.8rem;'><thead>";
  const numRows = Object.keys(data.id).length;
  for (let col1 of columnList) {
    result += `<th>${col1.name}</th>`;
  }
  result += "</thead><tbody>";
  for (let j = 0; j < numRows; j++) { 
    result += "<tr>";
    for (let col2 of columnList) {
      let val = data[col2.id][j] || "";
      let processedVal;
      if (col2.id === "strains") {
        processedVal =  renderStrainsCol(val, null, null);
      } else {
        processedVal = chunk_substr(val, col_max_len);
      }
      result += `<td>${processedVal}</td>`;
    }
    result += "</tr>";
  }
  result += "</tbody></table></div>";
  return result;
}

function fetchTargetConsequence(el, q) {
  const tr = el.closest('tr');
  const row = dTable.row(tr);

  if (cachedTargets[q]) {
    row.child(renderTargetConsequenceTable(cachedTargets[q])).show();
    highlight_selected_strains();
  } else {
    $.ajax({
      type: "POST",
      contentType: 'application/json',
      dataType: 'json',
      url: "{{ url_for('variant_browser.vbrowser_query_position') }}",
      data: JSON.stringify({query: q}),
      success:function(result) {
        cachedTargets[q] = result;
        row.child(renderTargetConsequenceTable(result)).show();
        highlight_selected_strains();
      },
      error:function(error) {
        console.error(error);
      }
    });
  }
}

function expandTargetConsequence(el, pos) {
  const tr = el.closest('tr');
  const row = dTable.row(tr);
  const chrom = dTable.cell(tr, 'chrom:name').data();
  const query = chrom + ":" + pos;
  if ( row.child.isShown() ) {
      // This row is already open - close it
      row.child.hide();
  }
  else {
      // Open this row
      //row.child( format(row.data()) ).show();
      fetchTargetConsequence(el, query)
  }
}



/* Table Data */

function populateDataTable() {
  // clear the table before populating it with more data
  dTable.clear();
  if (Object.keys(result_data).length == 0){
    dTable.columns.adjust().draw();
    return;
  }
  const variants = Object.keys(result_data.id);
  for(variant of variants) {
    const row_data = columnList.map(col => processCol(result_data[col['id']][variant], col['id']))
    $('#variant-table').dataTable().fnAddData(row_data);
  }
  filter_rows_by_impact();
  filter_rows_by_strains();
  dTable.columns.adjust().draw();
}




/* Initialization - Helper functions */


function init_data_table() {
  const colDefs = columnList.map((col, idx) => {
    let render = null;
    
    if (col.id === 'strains') {
      render = renderStrainsCol;
    }
    if (col.id === 'target_consequence') {
      render = renderTargetConsequenceCol;
    }
  
    return { 
      "name": col.id, 
      "render": render,
      "targets": idx,
      "visible": col['default_visibility'],
    } 
  });

  dTable = $('#variant-table').DataTable({
    colReorder: true,
    destroy: true,
    paging: true,
    pageLength: 100,
    dom:"ltipr",
    columnDefs: colDefs,
    order: [[ 1, "asc" ]]
  });

  dTable.on('column-reorder', function (e, settings, details) {
    setTimeout(highlight_selected_strains, 250);
  });

  dTable.on('page.dt', function () {
    setTimeout(highlight_selected_strains, 250);
  });

}


/* Set all columns to their default visibility values */
function select_default_columns() {

  /* Set checkboxes */
  columnList.forEach((col, idx) => {
    $( "#toggle_" + col.id ).prop("checked", col.default_visibility);
  });

  /* Set table columns */
  for (let i = 0; i < columnList.length; i++) {
    const column = dTable.column(i);
    column.visible(columnList[i].default_visibility);
  }

  /* Redraw the table */
  dTable.columns.adjust().draw();
}



/* Initialization - Set up event handlers */

$(document).ready(function() {

  // Get the default species from the selector
  update_species();

  (function($) {

    init_data_table();

    select_default_columns();
    
    const csrf_token = "{{ form.csrf_token._value() }}";

    const height = $('#col-select').height() + 'px';
    $('.pre-scrollable').css('max-height', height);

    /* Gene ortholog search */
    $("#gene-search").on("input", function(e) {
      $("#loading-search-table").fadeIn();
      clearTimeout(typingTimer);
      typingTimer = setTimeout(process_gene_search, doneTypingInterval);
    })

    /* Strain search */
    $('#strain-filter').keyup(function() {
        $('.select-searchable').hide();
        $(this).val().split(',').forEach(function(r) {
            var rex = new RegExp(r, "i");
            $('.select-searchable').filter(function() {
                return rex.test($(this).text());
            }).show();
        });
    });

    /* Filter by impact */
    $("#impact_high").change(function(e) {
      impactHigh = $(this).prop('checked');
      setTimeout(filter_rows_by_impact, 50);
    });

    $("#impact_low").change(function(e) {
      impactLow = $(this).prop('checked');
      setTimeout(filter_rows_by_impact, 50);
    });

    /* select/deselect all strains checkbox handler */
    $("#toggle_all_strains").change(function(e) {
      toggle_strain_lock = true;
      const state = $(this).prop('checked');

      // Apply new selection to all strains for current species
      $(`.toggle-strain-chk-${species.name}`).each(function(i, e) {
        e.checked = state;
      });
      update_selected_strains();

      setTimeout(filter_rows_by_strains, 50); /* allow checkbox to be clicked before processing */
      setTimeout(function() { 
        toggle_strain_lock = false;
      }, 50);
    });

    /* strain checkbox handler */
    $(".toggle-strain-chk").change(function() {
      if (!toggle_strain_lock) {
        const state = $(this).prop('checked');
        const strain = $(this).attr('data-column');
        if (!state) {
          selected_strains.delete(strain);
        } else {
          selected_strains.add(strain);
        }

        setTimeout(filter_rows_by_strains, 50); /* allow checkbox to be clicked before processing */
      }
    });

    /* select/deselect all columns handler */
    $("#toggle_all_cols").change(function(e) {
      const state = $(this).prop('checked');
      $(".toggle-col-chk").each(function(idx, e) {
        e.checked = state;
      });
      for (let i = 0; i < columnList.length; i++) {
        const column = dTable.column(i);
        column.visible(state);
      }
      dTable.columns.adjust().draw();
    });

    /* columns checkbox handler */
    $(".toggle-col-chk").change(function() {
      const state = $(this).prop('checked');
      const colName = $(this).attr('data-column') + ':name';
      const column = dTable.column(colName);
      
      column.visible(state);
      dTable.columns.adjust().draw();
    });

    $("#search-interval-btn").on("click", function(e) {
      e.preventDefault();
      toggleDisableForm(true);
      $("#download-result-btn").attr('disabled', true);
      form = document.getElementById('form-submit-interval');
      if (!form.checkValidity() || $("#interval").val().length == 0) {
        form.reportValidity();
        toggleDisableForm(false);
        return;
      }
      const data = {
        query: $("#interval").val()
      };
      hideTable();

      $.ajax({
				type: "POST",
        contentType: 'application/json',
        dataType: 'json',
				url: "{{ url_for('variant_browser.vbrowser_query_interval') }}",
				data: JSON.stringify(data),
				success:function(result) {
          const has_results = !!Object.keys(result).length;
          $("#download-result-btn").attr('disabled', !has_results);

          toggleDisableForm(false);
          cachedTargets = {};
          result_data = result;
          populateDataTable();
          showTable();
				},
        error:function(error) {
          console.error(error);
          toggleDisableForm(false);
        }
      });
    
    });

    $.ajaxSetup({
      beforeSend: function(xhr, settings) {
          if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
              xhr.setRequestHeader("X-CSRFToken", csrf_token);
          }
      }
    });

  }(jQuery));
});


</script>
{% endblock %}

