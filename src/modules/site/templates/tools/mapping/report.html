{% extends "_layouts/default.html" %}

{% block custom_head %}

{% endblock %}

{% block content %}

  <div class="row">
    <div class="col-lg-2 col-lg-offset-3 col-md-4 col-sm-4 btn-mid-row">
      <a class="btn btn-block btn-nu " href="{{ data_url }}" role="button">
        <span class="glyphicon glyphicon-download" aria-hidden="true"></span> 
        Download Data
      </a>
    </div>
    <div class='col-lg-2 col-md-4 col-sm-4 btn-mid-row'>
      <a class="btn btn-block btn-nu " href="{{ url_for('mapping.mapping_results', id=id) }}" role="button">
        <span class="glyphicon glyphicon-download" aria-hidden="true"></span> 
        View Result Files
      </a>
    </div>
    <div class='col-lg-2 col-md-4 col-sm-4 btn-mid-row'>
    {% if report_url %}
      <a class="btn btn-block btn-nu " href="{{ report_url }}" role="button">
    {% else %}
      <a class="btn btn-block btn-nu " href="" role="button" disabled>
    {% endif %}
        <span class="glyphicon glyphicon-stats" aria-hidden="true"></span> 
        Download Report
      </a>
    </div>
  </div>{# /row #}


{% if mapping.status == 'COMPLETE' %}

  <div class="row">
    <div class="col-md-12 text-center" >
      <div id="report_frame" width="100%" height="800px" >
        <div class="spinner">
          <div class="bounce1"></div>
          <div class="bounce2"></div>
          <div class="bounce3"></div>
        </div>
        <small>
          Last Update: <span id="last-update"></span>
        </small>
      </div>
    </div>
  </div> {# /row #}

{% elif mapping.status == 'ERROR' %}

<div class="row">
  <div class='col-md-12'>
      <p class='text-info text-center'>
        <strong>
          An error occurred while performing the genome-wide association mapping. Check that the data you provided matches the expected format.
        </strong>
      </p>
  </div> {# /col-md-12 #}
</div>{# /row #}


{% else %}

  <div class="row">
    <div class='col-md-12'>
        <p class='text-info text-center'>
          <strong>
              The genome-wide association mapping is currently being run - please check back in a few hours for results.
          </strong>
        </p>
    </div> {# /col-md-12 #}
  </div>{# /row #}

{% endif %}

{% endblock %}


{% block script %}

<script>

  // settings
  const report_status_url = `{{ report_status_url }}`;
  const REFRESH_DURATION_MS = 30000;

  function createIFrame(url) {
    const $container = document.querySelector('#report_frame');
    $container.innerHTML = ""; // (optional) Totally Clear it if needed

    console.debug({url});
    const $iframe = document.createElement("iframe");
    $iframe.src = url;
    $iframe.width = "100%";
    $iframe.height = "800px";

    $container.appendChild($iframe);

    return $iframe;
  }


  const $lastTime = document.querySelector("#last-update");
  function updateLastTime() {
    if (!$lastTime) return;
    const now = new Date();
    const time = `${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;
    $lastTime.innerText = time;
  }

  async function getStatusUpdate() {
    try {
      const res = await fetch(report_status_url, {
        headers: {
          'Content-Type': 'application/json'
        }
      });
      const { done, report_url } = await res.json();
      if (!done) {
        return setTimeout(getStatusUpdate, REFRESH_DURATION_MS);
      }
      createIFrame(report_url);
    } catch (err) {
      console.error(err);
    } finally {
      updateLastTime()
    }
  }

  getStatusUpdate();

</script>


{% endblock %}