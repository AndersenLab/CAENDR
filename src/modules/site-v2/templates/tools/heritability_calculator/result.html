{% extends "_layouts/default-nocontainer.html" %}

{% block custom_head %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-lightbox/0.7.0/bootstrap-lightbox.css" rel="stylesheet" />
<link rel="stylesheet" href="/static/css/d3-exploding-boxplot.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.7/d3.js" charset="utf-8"></script>
<script src="https://d3js.org/queue.v1.min.js"> </script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.6.7/d3-tip.min.js"></script>
<script src="{{ ext_asset('js/d3-exploding-boxplot.js') }}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.4.1/jspdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.4.1/html2canvas.min.js"></script>
<script type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.2/FileSaver.min.js"></script>

{% if not (result or hr.status in [TaskStatus.ERROR, TaskStatus.COMPLETE]) %}
<meta http-equiv="refresh" content="10; url={{ request.path }}">
{% endif %}

<style>
  #closeButton {
    display:none;
  }
</style>

{% endblock %}


{% block content %}

<div class="container-fluid px-5 pb-5">
  <div class="d-flex justify-content-around flex-wrap mt-2">
  <!-- Results Card -->
  <div class="col col-md-6 col-xl-3 text-bg-light mb-5 p-5 rounded-2 shadow-sm overflow-auto" style="max-height:75vh;">
    <p>
      <strong>Trait:</strong> {{ hr.trait }}
    </p>
    <p>
      <strong>Description:</strong> {{ hr.label }}
    </p>
    <p>
      <strong>Report ID:</strong> {{ hr.id }}
    </p>
    <p>
      <strong>Created:</strong> {{ hr.created_on | date_format }}
    </p>
    <p>
      <strong>Status:</strong>  {{ hr.status }}
    </p>

    {%- if hr.status == TaskStatus.ERROR %}
    {%- if session["is_admin"] %}
    <p>
      <strong>Error:</strong> <span class="text-danger">{{ operation.error }}</span>
    </p>
    {%- endif %}
    {%- endif %}

    {%- if result and result['broad-sense'] %}
    <p>
      <strong>Broad-Sense Heritability (H<sup>2</sup>):</strong> {{ (result['broad-sense']['H2']*100)|round(2) }}%
      <small>(range {{ (result['broad-sense']['ci_l']*100)|round(2) }}% to {{ (result['broad-sense']['ci_r']*100)|round(2) }}%)</small>
    </p>
    {%- endif %}
    {%- if result and result['narrow-sense'] %}
    <p>
      <strong>Narrow-Sense Heritability (h<sup>2</sup>):</strong> {{ (result['narrow-sense']['H2']*100)|round(2) }}%
      <small>(range {{ (result['narrow-sense']['ci_l']*100)|round(2) }}% to {{ (result['narrow-sense']['ci_r']*100)|round(2) }}%)</small>
    </p>
    {%- endif %}
    <div class="mt-5">
      <div class="d-grid gap-3">
        <a class="btn btn-secondary text-light" role="button" onClick="getPDF()">Download PDF</a>
        <a class="btn btn-secondary text-light" role="button" onClick="window.open('{{ data_url }}')">Download TSV</a>
        {%- if session["is_admin"] %}
        <a class="btn btn-secondary text-light" role="button" href="{{ url_for('heritability_calculator.view_logs', id=hr.id)}}">View Logs</a>
        {%- endif %}
      </div>
    </div>
  </div>
  <!-- /Input Card -->
  <!-- Tool column -->
  <div class="d-flex flex-wrap flex-column col-md-12 col-xl-8">
      <!-- Options Toolbar -->
      <div class="d-flex flex-wrap justify-content-end col-12 text-end mb-3 optionsToolbar">
      <div class="ps-3 pt-0"><a href="{{ url_for('heritability_calculator.heritability_calculator') }}"><i class="bi bi-plus-circle" aria-hidden="true"></i> New Calculation</a></div>
      <div class="ps-3 pt-0"><a href="{{ url_for('heritability_calculator.my_results') }}"><i class="bi bi-journal" aria-hidden="true"></i>View All My Heritability Results</a></div>
      {% if data %}
      {% if hr.status == TaskStatus.COMPLETE %}
      <div class="ps-3 pt-0"><button class="btn border-0" onclick="openFullscreen();" id="fullscreenButton"><i class="bi bi-arrows-fullscreen" aria-hidden="true"></i>View Fullscreen</button></div>
      {% endif %}
      {% endif %}
      </div>
      <!-- /Options Toolbar -->
      <!-- Heritability Results -->
      <div class="col">
        {% if data and not result %}
        {% if not hr.status in [TaskStatus.COMPLETE, TaskStatus.ERROR] %}
        <p class='text-info text-center'>
          <strong>
            The heritability calculation is currently being run. Please check back in a few minutes for results.
            This page will reload automatically.
          </strong>
        </p>
        <div class="col-9 alert alert-info mt-5 mx-auto animate__animated animate__fadeIn">
          <p class="fs-2 text-center"><i class="bi bi-arrow-clockwise" aria-hidden="true"></i></p>
          <p class="lead">The heritability calculation is currently being run. Please check back in a few minutes for results. This page will reload automatically.</p>
      </div>
        {% endif %}
      
        {% else %}
        <div id="dataContainer">
          <div id="htresarea"></div>
        </div>
      
        {% if data %}
        <div class="bg-white" id="chartContainer">
          <div class="d-flex flex-wrap justify-content-center col-12 text-end optionsToolbar">
            <div class="me-5">
              <button class="btn btn-danger text-light p-2 my-5" onclick="closeFullscreen();" id="closeButton"><i
                  class="bi bi-fullscreen-exit text-light" aria-hidden="true"></i> Close Fullscreen</button>
            </div>
          </div>
          <div id="svgchartarea"></div>
        </div>
        {% endif %}
      
        {% if result %}
        <div id='resultDiv' hidden>
          <canvas id="canvas"></canvas>
          <div id="png-container"></div>
        </div>
      
        {% endif %}
        {% endif %}

        {% if hr.status == TaskStatus.ERROR %}
        <div class="col-9 alert alert-danger mt-5 mx-auto animate__animated animate__fadeInDown">
          <p class="fs-2 text-center"><i class="bi bi-exclamation-circle-fill me-2" aria-hidden="true"></i></p>
          <p class="lead">We're sorry but an error occurred while performing this report. Please verify that the data you submitted is correct and matches the expected format.</p>
        </div>
        {% endif %}
      </div>
  <!-- /Tool Column -->
 </div>
 <!-- /Flex -->
</div> <!-- /Container -->

{% endblock %}

{% block script %}
{% if result  %}
  <script>
    Element.prototype.remove = function() {
        this.parentElement.removeChild(this);
    }
    NodeList.prototype.remove = HTMLCollection.prototype.remove = function() {
        for(var i = this.length - 1; i >= 0; i--) {
            if(this[i] && this[i].parentElement) {
                this[i].parentElement.removeChild(this[i]);
            }
        }
    }

    let imag;
    let chartJson = {{ data|tojson|safe }};

    let maxP = 1;
    let minP = 1;
    let curP = 1;
    let strn = [];

    function sortByProperty(property) {
      return function(a,b) {
        if (a[property] > b[property])
          return 1;
        else if (a[property] < b[property])
          return -1;
        return 0;
      }
    }

    function ppage() {
        curP = (curP === 1) ? 1 : curP-1;
        loadPlot(curP);
    }

    function npage() {
        curP = (curP === maxP) ? maxP : curP+1;
        loadPlot(curP);
    }

    function range(start, end){
        if (start===end){return ([start,]);}
        if (start<end){return ([start, ...range(start + 1, end)]);}
        if (end<start){return ([start, ...range(start - 1, end)]);}
    }

    function getRandomColor() {
        const letters = '123456789ABCDEF'.split('');
        let color = '#';
        for (let i = 0; i < 6; i++ ) {
                color += letters[Math.round(Math.random() * 14)];
        }
        return color;
    }

    let renderPlot;
    let cpal = []
    function loadPlot(jj) {
        df = [];
        ran = range(25*(jj-1), (25*(jj)-1));
        chartJson.forEach(function(d,i){
            if (ran.indexOf((strn.indexOf(d['Strain'])))>-1) { df.push(d); }
        });
        UniqueNames= $.unique(chartJson.map(function (d) {return d.a;}));
        if (cpal.length == 0){
            for (var cc=0; cc<UniqueNames.length; cc++){cpal.push(getRandomColor())};
        }

        // Create & save a function to compute the chart size & re-render it
        renderPlot = () => {

          // Clear the current chart area
          // Otherwise chart can't shrink - width computation will always be based on existing size
          document.getElementById("svgchartarea").innerHTML = "";

          // Take up as much horizontal space as available, keeping a 16:9 ratio
          width = document.getElementById("svgchartarea").offsetWidth - 100; /* 100px is from the chart legend*/
          height = 9 * width / 16;

          // Create the chart and render in the page
          const chart = d3.exploding_boxplot(df, {y:'Value', group:'Strain', color:'AssayNumber', label:'TraitName', pal:cpal})
                          .width(width)
                          .height(height);
          chart('#svgchartarea');
        }

        // Call the new render plot function
        renderPlot();
    }

    async function drawImg(canvas, image, DOMURL, w, h) {
        return new Promise(resolve => {
          image.onload = function () {
            const ctx = canvas.getContext("2d");
            ctx.fillStyle = "#FFFFFF";
            ctx.fillRect(0, 0, w, h);
            ctx.drawImage(image, 0, 0, w, h);
            const png = canvas.toDataURL("image/png");
            imag = png
            document.getElementById('png-container').innerHTML = `<img id="img1" src="${png}"/>`;
            DOMURL.revokeObjectURL(png);
            if (this.complete) {
              imag = this.src
            }
            resolve('resolved');
          }
        });
    }

    function loadCanvas() {
      const svgString = new XMLSerializer().serializeToString(document.querySelector('svg'));

      const canvas = document.getElementById("canvas");
      canvas.width = 1000;
      canvas.height = 480;
      const DOMURL = self.URL || self.webkitURL || self;
      const image = document.createElement("IMG");
      const svg = new Blob([svgString], {type: "image/svg+xml;charset=utf-8"});
      const url = DOMURL.createObjectURL(svg);

      drawImg(canvas, image, DOMURL, canvas.width, canvas.height).then(() => {

        const source = document.getElementById('dataContainer');
        const options = {
          orientation: 'landscape',
          format: 'a4',
          unit: 'px',

        }
        const doc = new jsPDF(options);

        margins = {
            top: 60,
            bottom: 40,
            left: 40,
            right: 40
        };

        page_height = doc.internal.pageSize.getHeight();
        page_width  = doc.internal.pageSize.getWidth();
        /*doc.addImage(document.getElementById('svg'), 'SVG', 0, 0, page_width, page_height, NaN, 'NONE', 90);*/
        doc.setFontSize(16);
        doc.fromHTML('Trait: {{ hr.trait }}', 120, 10)

        doc.fromHTML('Broad-sense heritability (<i> H</i>',  120, 20)
        doc.setFontSize(4);
        doc.fromHTML('<i>2</i>', 225, 15)
        doc.setFontSize(10);
        {%- if result['broad-sense'] %}
        doc.fromHTML(') = {{ (result["broad-sense"]['H2']*100)|round(2) }}% (range {{ (result["broad-sense"]['ci_l']*100)|round(2) }}% to {{ (result["broad-sense"]['ci_r']*100)|round(2) }}%)', 230, 20);
        {%- endif %}

        doc.fromHTML('Narrow-sense heritability (<i> h</i>',  120, 30)
        doc.setFontSize(4);
        doc.fromHTML('<i>2</i>', 225, 25)
        doc.setFontSize(10);
        {%- if result['narrow-sense'] %}
        doc.fromHTML(') = {{ (result["narrow-sense"]['H2']*100)|round(2) }}% (range {{ (result["narrow-sense"]['ci_l']*100)|round(2) }}% to {{ (result["narrow-sense"]['ci_r']*100)|round(2) }}%)', 230, 30);
        {%- endif %}

        doc.addImage(document.getElementById('img1').src, 'PNG', margins.left, margins.top,
                    page_width - (margins.left + margins.right),
                    page_height - (margins.top + margins.bottom),
                    NaN, 'NONE', 0);

        doc.addPage();
        doc.setFontSize(16);
        doc.text(doc.internal.pageSize.getWidth()/2, 50, 'Heritability Calculator', {'align': 'center'});
        doc.fromHTML('The broad-sense heritability is the amount of trait variance that comes from genetic differences in the assayed group ', 20, 85, {'align': 'justify', 'maxWidth': doc.internal.pageSize.getWidth()-40},function(){},margins)
        doc.fromHTML('of strains. Generally, it is the ratio of genetic variance to total (genetic plus environmental) variance.', 20, 100, {'align': 'justify', 'maxWidth': doc.internal.pageSize.getWidth()-40},function(){},margins)

        const a = document.createElement('a');
        const pdfblob = new Blob([ doc.output('blob') ], { type : 'application/pdf'});
        a.href = window.URL.createObjectURL(pdfblob);
        a.download = "{{ fname }}.pdf";
        a.click();
      })
      image.src = url;
    }

    function getPDF() {
      loadCanvas();
    }

    $(document).ready(function() {
      if (chartJson.length != 0) {
        // var node = document.getElementById("svgchartarea");
        $("#svgchartarea").html("")
        //node.querySelectorAll('*').forEach(n => n.remove());
        newPt = document.createElement("p")
        {# // newPt.innerHTML = "Broad-sense heritability (<i> H<sup>2</sup> </i>) = {{ (result['H2']*100)|round(2) }}% (range {{ (result['ci_l']*100)|round(2) }}% to {{ (result['ci_r']*100)|round(2) }}%)"; #}
        document.getElementById("htresarea").appendChild(newPt);
        newPt = document.createElement("p")
        // newPt.appendChild(document.createTextNode("Trait: " + "{{ hr.trait }}"));
        document.getElementById("htresarea").appendChild(newPt);

        // chart(data,aes)
        // aesthetic :
        // y : point's value on y axis Value
        // group : how to group data on x axis Strain
        // color : color of the point / boxplot AssayNumber
        // label : displayed text in toolbox AssayNumber_Strain_Replicate : Value
        console.log(chartJson)
        chartJson.sort(sortByProperty("Strain"));
        chartJson.forEach(function(d,i){
          if (strn.indexOf(d['Strain']) == -1) {
            strn.push(d['Strain']);}
          });
        maxP = ((strn.length % 25) > 0) ? parseInt(strn.length / 25)+1 : parseInt(strn.length / 25);

        loadPlot(1);
      } else {
        newPt.appendChild(document.createTextNode("Chart data is empty!"));
      }

      $("a[href^='http://'], a[href^='https://'], a[href$='pdf']").attr("target","_blank");

    })

    // When fullscreen changes, recompute plot to update size
    window.addEventListener('fullscreenchangefinished', () => {
      renderPlot();
    });

    // For viewing tool in fullscreen
    {% include '_scripts/fullscreen.js' %} {#/* fullscreen for tools */#}
    let fullscreenBrowser = document.getElementById("chartContainer");

  </script>
{% endif %}
{% endblock %}
