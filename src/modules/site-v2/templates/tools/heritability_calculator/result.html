{% extends "_layouts/default-nocontainer.html" %}

{% block custom_head %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-lightbox/0.7.0/bootstrap-lightbox.css" rel="stylesheet" />
<link rel="stylesheet" href="/static/css/d3-exploding-boxplot.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.7/d3.js" charset="utf-8"></script>
<script src="https://d3js.org/queue.v1.min.js"> </script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.6.7/d3-tip.min.js"></script>
<script src="{{ ext_asset('js/d3-exploding-boxplot.js') }}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.4.1/jspdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.4.1/html2canvas.min.js"></script>
<script type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.2/FileSaver.min.js"></script>

{% if not (result or hr.status in [TaskStatus.ERROR, TaskStatus.COMPLETE]) %}
<meta http-equiv="refresh" content="10; url={{ request.path }}">
{% endif %}

{% endblock %}


{% block content %}

<div class="container-fluid px-5 pb-5">
  <div class="d-flex justify-content-around flex-wrap mt-2">
  <!-- Results Card -->
  <div class="col col-md-6 col-xl-3 text-bg-light mb-5 p-5 rounded-2 shadow-sm overflow-auto" style="max-height:500px">
    <p>
      <strong>Trait:</strong> {{ hr.trait }}
    </p>
    <p>
      <strong>Description:</strong> {{ hr.label }}
    </p>
    <p>
      <strong>Report ID:</strong> {{ hr.id }}
    </p>
    <p>
      <strong>Created:</strong> {{ hr.created_on | date_format }}
    </p>
    <p>
      <strong>Status:</strong>  {{ hr.status }}
    
      {% if hr.status == TaskStatus.ERROR %}
      <strong>Error:</strong> <span class="text-danger">{{ operation.error }}</span>
      {% endif %}
    </p>
    {%- if result %}
    <p>
      <strong>Broad-Sense Heritability (H<sup>2</sup>):</strong> {{ (result['H2']*100)|round(2) }}% <small>(range {{ (result['ci_l']*100)|round(2) }}% to {{ (result['ci_r']*100)|round(2) }}%)</small>
    </p>
    {%- endif %}
  <div class="mt-5">
    <div class="d-grid gap-3">
      <a class="btn btn-secondary text-light" role="button" onClick="getPDF()">Download PDF</a>
      <a class="btn btn-secondary text-light" role="button" onClick="window.open('{{ data_url }}')">Download TSV</a>
    </div>
  </div>
  </div>
  <!-- /Input Card -->
  <!-- Tool column -->
  <div class="d-flex flex-wrap flex-column col-md-12 col-xl-8">
      <!-- Options Toolbar -->
      <div class="d-flex flex-wrap justify-content-end col-12 text-end mb-3 optionsToolbar">
      <div class="ps-3 pt-0"><a href="{{ url_for('heritability_calculator.heritability_calculator') }}"><i class="bi bi-plus-circle" aria-hidden="true"></i> New Calculation</a></div>
      <div class="ps-3 pt-0"><a href="{{ url_for('heritability_calculator.my_results') }}"><i class="bi bi-journal" aria-hidden="true"></i>View All My Heritability Results</a></div>
      <div class="ps-3 pt-0"><a href="#"><i class="bi bi-arrows-fullscreen" aria-hidden="true"></i> Fullscreen</a></div>
      </div>
      <!-- /Options Toolbar -->
      <!-- Heritability Results -->
      <div class="col">
        {% if data and not result %}
        {% if not hr.status in [TaskStatus.COMPLETE, TaskStatus.ERROR] %}
        <p class='text-info text-center'>
          <strong>
            The heritability calculation is currently being run. Please check back in a few minutes for results.
            This page will reload automatically.
          </strong>
        </p>
        {% endif %}
      
        {% else %}
        <div id="dataContainer">
          <div id="htresarea"></div>
        </div>
      
        {% if data %}
        <div id="svgchartarea"></div>
        {% endif %}
      
        {% if result %}
        <div id='resultDiv' hidden>
          <canvas id="canvas"></canvas>
          <div id="png-container"></div>
        </div>
      
        {% endif %}
        {% endif %}
      </div>
  <!-- /Tool Column -->
 </div>
 <!-- /Flex -->
</div> <!-- /Container -->

{% endblock %}

{% block script %}
{% if result  %}
    <script>
    Element.prototype.remove = function() {
            this.parentElement.removeChild(this);
        }
    NodeList.prototype.remove = HTMLCollection.prototype.remove = function() {
            for(var i = this.length - 1; i >= 0; i--) {
                if(this[i] && this[i].parentElement) {
                    this[i].parentElement.removeChild(this[i]);
                }
            }
        }

    var trait = "{{ trait }}"
    var imag
    var chartJson = {{ data|tojson|safe }};
    var traits =[];
    var img, ctx, canvs;
    var maxP = 1;
    var minP = 1;
    var curP = 1;
    var strn = [];

    var sortByProperty = function(property){
       return function(a,b){
          if(a[property] > b[property])
             return 1;
          else if(a[property] < b[property])
             return -1;

          return 0;
       }
    }

    var ppage = function(){
        curP= (curP===1)? 1:curP-1;
        loadPlot(curP);
    }

    var npage = function(){
        curP= (curP===maxP)?maxP:curP+1;
        loadPlot(curP);
    }

    function range(start, end){
        if (start===end){return ([start,]);}
        if (start<end){return ([start, ...range(start + 1, end)]);}
        if (end<start){return ([start, ...range(start - 1, end)]);}
    }

    function getRandomColor() {
        var letters = '123456789ABCDEF'.split('');
        var color = '#';
        for (var i = 0; i < 6; i++ ) {
                color += letters[Math.round(Math.random() * 14)];
        }
        return color;
    }

    var cpal = []
    var loadPlot = function(jj){
        df = [];
        ran = range(25*(jj-1), (25*(jj)-1));
        chartJson.forEach(function(d,i){
            if (ran.indexOf((strn.indexOf(d['Strain'])))>-1) { df.push(d); }
        });
        UniqueNames= $.unique(chartJson.map(function (d) {return d.a;}));
        if (cpal.length == 0){
            for (var cc=0; cc<UniqueNames.length; cc++){cpal.push(getRandomColor())};
        }

        width = document.getElementById("svgchartarea").offsetWidth - 100; /* 100px is from the chart legend*/
        height = 9 * width / 16;
        console.log(width)
        var chart = d3.exploding_boxplot(df, {y:'Value', group:'Strain', color:'AssayNumber', label:'TraitName', pal:cpal})
                      .width(width)
                      .height(height);
        document.getElementById("svgchartarea").innerHTML = "";
        chart('#svgchartarea');
    }

    async function drawImg(canvas, image, DOMURL, w, h){
        return new Promise(resolve => {
          image.onload = function () {
            var ctx = canvas.getContext("2d");
            ctx.fillStyle = "#FFFFFF";
            ctx.fillRect(0, 0, w, h);
            ctx.drawImage(image, 0, 0, w, h);
            var png = canvas.toDataURL("image/png");
            imag = png
            document.getElementById('png-container').innerHTML = '<img id="img1" src="'+png+'"/>';
            DOMURL.revokeObjectURL(png);
            if (this.complete){
              imag = this.src
            }
            resolve('resolved');
          }
        });
      }

    var loadCanvas = function(){
        var svgString = new XMLSerializer().serializeToString(document.querySelector('svg'));

        var canvas = document.getElementById("canvas");
        canvas.width = 1000;
        canvas.height = 480;
        var ctx = canvas.getContext("2d");
        var DOMURL = self.URL || self.webkitURL || self;
        image = document.createElement("IMG");
        var svg = new Blob([svgString], {type: "image/svg+xml;charset=utf-8"});
        var url = DOMURL.createObjectURL(svg);

        drawImg(canvas, image, DOMURL, canvas.width, canvas.height).then(() => {


        var source = document.getElementById('dataContainer');
        const options = {
          orientation: 'landscape',
          format: 'a4',
          unit: 'px',

        }
        var doc = new jsPDF(options);

        margins = {
            top: 40,
            bottom: 40,
            left: 40,
            right: 40
        };

        page_height = doc.internal.pageSize.getHeight();
        page_width = doc.internal.pageSize.getWidth();
        /*doc.addImage(document.getElementById('svg'), 'SVG', 0, 0, page_width, page_height, NaN, 'NONE', 90);*/
        doc.setFontSize(16);
        doc.fromHTML('Trait: {{ trait }}', 120, 10)
        doc.fromHTML('Broad-sense heritability (<i> H</i>',  120, 20)
        doc.setFontSize(4);
        doc.fromHTML('<i>2</i>', 225, 15)
        doc.setFontSize(10);
        {% if result %}
        doc.fromHTML(') = {{ (result['H2']*100)|round(2) }}% (range {{ (result['ci_l']*100)|round(2) }}% to {{ (result['ci_r']*100)|round(2) }}%)', 230, 20);
        {% endif %}

        doc.addImage(document.getElementById('img1').src, 'PNG', margins.left, margins.top,
                    page_width - (margins.left + margins.right),
                    page_height - (margins.top + margins.bottom),
                    NaN, 'NONE', 0);

        doc.addPage();
        doc.setFontSize(16);
        doc.text(doc.internal.pageSize.getWidth()/2, 50, 'Heritability Calculator', {'align': 'center'});
        doc.fromHTML('The broad-sense heritability is the amount of trait variance that comes from genetic differences in the assayed group ', 20, 85, {'align': 'justify', 'maxWidth': doc.internal.pageSize.getWidth()-40},function(){},margins)
        doc.fromHTML('of strains. Generally, it is the ratio of genetic variance to total (genetic plus environmental) variance.', 20, 100, {'align': 'justify', 'maxWidth': doc.internal.pageSize.getWidth()-40},function(){},margins)

        var a = document.createElement('a');
            var pdfblob = new Blob([ doc.output('blob') ], { type : 'application/pdf'});
            a.href = window.URL.createObjectURL(pdfblob);
            a.download = "{{ fname }}.pdf";
            a.click();
        })
        image.src = url;
    }

    var getPDF = function(){
      loadCanvas();
    }

    $(document).ready(function(){
      if (chartJson.length != 0){
        var node= document.getElementById("svgchartarea");
        $("#svgchartarea").html("")
        //node.querySelectorAll('*').forEach(n => n.remove());
        newPt = document.createElement("p")
        // newPt.innerHTML = "Broad-sense heritability (<i> H<sup>2</sup> </i>) = {{ (result['H2']*100)|round(2) }}% (range {{ (result['ci_l']*100)|round(2) }}% to {{ (result['ci_r']*100)|round(2) }}%)";
        document.getElementById("htresarea").appendChild(newPt);
        newPt = document.createElement("p")
        // newPt.appendChild(document.createTextNode("Trait: " + "{{ trait }}"));
        document.getElementById("htresarea").appendChild(newPt);

        // chart(data,aes)
        // aesthetic :
        // y : point's value on y axis Value
        // group : how to group data on x axis Strain
        // color : color of the point / boxplot AssayNumber
        // label : displayed text in toolbox AssayNumber_Strain_Replicate : Value
        console.log(chartJson)
        chartJson.sort(sortByProperty("Strain"));
        chartJson.forEach(function(d,i){
          if (strn.indexOf(d['Strain']) == -1) {
            strn.push(d['Strain']);}
          });
        maxP = ((strn.length % 25) > 0) ? parseInt(strn.length / 25)+1 : parseInt(strn.length / 25);

        loadPlot(1);
      } else {
        newPt.appendChild(document.createTextNode("Chart data is empty!"));
      }

      $("a[href^='http://'], a[href^='https://'], a[href$='pdf']").attr("target","_blank");

    })
    </script>
{% endif %}


{% endblock %}