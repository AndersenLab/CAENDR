{% extends "_layouts/default-nocontainer.html" %}

{% block custom_head %}

<!-- D3js -->
<script src="//d3js.org/d3.v4.min.js"></script>

<style>
    .tooltip {
        position: absolute;
        font-size: 12px;
        width:  auto;
        height: auto;
        border: 1px solid black;
        pointer-events: none;
        background-color: white;
    }

    .tooltip p {
        margin-bottom: 0;
    }

    .tooltip .tooltip-head {}

    .tooltip .tooltip-body {
        padding: 0 4px;
    }

    #closeButton {
    display:none;
  }

    #chartContainer {
        background-color: #FEFCFB;
    }

    @media screen and (min-width: 768px) {
  #chartContainer {
    min-height:900px;
  }

  #phenotype-chart svg {
    width: 65%;
    height: 65%;
  }
}
</style>

{% endblock %}


{% block content %}

<div class="container-fluid px-md-5 pb-5">
    <div class="d-flex justify-content-around flex-wrap mt-2">
        <!-- Results Card -->
        <div class="col col-md-6 col-xl-3 text-bg-light mb-5 p-5 rounded-2 shadow-sm overflow-auto" style="max-height: 145vh;">
            <div><h2 class="h3 text-center mb-5">Trait Information</h2>

            {%- if data.num_traits > 1 %}
            <h3 class="h4 text-dark">Trait 1</h3>
            {%- endif %}
            <p><strong>Name:</strong></p>
            <p>{{ report['trait_1_name'] }}</p>
            <p><strong>Description</strong></p>
            <p>{{ report['trait_1']['description_short'] or report['trait_1']['description_long'] }}</p>

            {%- if data.num_traits > 1 %}
            <h3 class="h4 text-dark">Trait 2</h3>
            <p><strong>Name:</strong></p>
            <p>{{ report['trait_2_name'] }}</p>
            <p><strong>Description</strong></p>
            <p>{{ report['trait_2']['description_short'] or report['trait_2']['description_long'] }}</p>
            <h3 class="h4 text-dark">Correlation</h3>
            <p>{{ result.correlation|round(4) }}</p>
            <h3 class="h4 text-dark">P-Value</h3>
            <p>{{ result.p_value|round(4) }}</p>
            {%- endif %}
            </div>
            <div class="my-5">
                <div class="d-grid gap-3">
                  <a class="btn btn-secondary text-light" role="button" onClick=""><i class="bi bi-image-fill me-2"></i>Download SVG</a>
                  <a class="btn btn-secondary text-light" role="button" onClick=""><i class="bi bi-file-earmark-spreadsheet-fill me-2"></i>Download TSV</a>
                </div>
              </div>
        </div>
        <!-- /Input Card -->
        <!-- Tool column -->
        <div class="d-flex flex-wrap flex-column col-md-12 col-xl-8">
            <!-- Options Toolbar -->
            <div class="d-flex flex-wrap justify-content-end col-12 text-end mb-3 optionsToolbar">
                <div class="ps-3 pt-0"><a href="{{ url_for('phenotype_database.phenotype_database') }}"><i class="bi bi-plus-circle" aria-hidden="true"></i> New Analysis</a></div>
                <div class="ps-3 pt-0"><a href="{{ url_for('phenotype_database.my_results') }}"><i class="bi bi-journal" aria-hidden="true"></i>View All My Phenotype Results</a></div>
                <div class="ps-3 pt-0"><button class="btn border-0" onclick="openFullscreen();" id="fullscreenButton"><i class="bi bi-arrows-fullscreen" aria-hidden="true"></i>View Fullscreen</button></div>
            </div>
            <!-- /Options Toolbar -->
            <!-- Widget Placeholder -->
            <div class="row">
            <div class="col overflow-auto" id="chartContainer">
                <div>
                    <button class="btn btn-danger text-light p-2 my-5 mx-auto" onclick="closeFullscreen();" id="closeButton"><i
                        class="bi bi-fullscreen-exit text-light" aria-hidden="true"></i> Close Fullscreen</button>
                  </div>
                    <div id="phenotype-chart" class="text-center mb-5"></div>
                    <div id="phenotype-chart-single-trait" class="text-center mb-5"></div>
                    {%- if data.num_traits > 1 %}
                    <div class="col-9 alert alert-info mt-5 mx-auto">
                        <p class="text-small text-center">
                            <i class="bi bi-info-circle-fill me-2" aria-hidden="true"></i>
                            <br>
                            The data were mean centered and scaled to have a standard deviation of 1. These operations do not affect
                            correlation tests and make the data easier to evaluate in a plot.
                        </p>
                    </div>
                    {%- endif %}
                <!-- <svg class="bd-placeholder-img bd-placeholder-img-lg img-fluid border-0" width="100%"
                                style="height: 100%" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Placeholder: Widget"
                                preserveAspectRatio="xMidYMid slice" focusable="false">
                                <title>Placeholder</title>
                                <rect width="100%" height="100%" fill="#868e96"></rect><text x="50%" y="50%" fill="#dee2e6"
                                    dy=".3em">Widget
                                    Placeholder</text>
                            </svg> -->
            </div>
        </div>
            <!-- Widget Placeholder -->
        </div>
        <!-- /Tool Column -->
    </div>
    <!-- /Flex -->
</div> <!-- /Container -->

{% endblock %}


{% block script %}
{% from "_includes/macros.html" import label_string_units %}

<script type="text/javascript">
     // For viewing tool in fullscreen
 {% include '_scripts/fullscreen.js' %}
</script>

<script src="{{ url_for('static', filename='js/plot.js') }}"></script>

<script type="module">

const data = {{ result.trait_values|tojson }};

{%- if data.num_traits == 1 %}
// Render chart(s) for one trait

const trait_label = {{ label_string_units(data.trait_names[0], report['trait_1']['units']) }};

try {
    render_histogram('#phenotype-chart-single-trait', data, {
         width:         1200,
        // height:        300,
        fill_color:    '#0719BC',
        bins_per_tick: 2,
        x_label:       trait_label,
        tooltip_id:    'tooltip-single-histogram',
        tooltip_template: (d, labels) => `
            <p class="tooltip-head"><b>Strain: ${d[2]}</b></p>
            <p class="tooltip-body">${labels[0]}: ${d[0]}</p>
        `,
    });
} catch (err) {
    console.error(`Could not construct histogram. ${err}`)
}

try {
    render_ranked_barplot('#phenotype-chart-single-trait', data, {
        width:         1200,
        // height:        400,
        fill_color:    '#0719BC',
        y_label:       trait_label,
        tooltip_id:    'tooltip-single-barplot',
        tooltip_template: (d) => `
            <p class="tooltip-head"><b>${d[1]}</b></p>
            <p class="tooltip-body">Value = ${d[0]}</p>
        `,
    });
} catch (err) {
    console.error(`Could not construct ranked bar plot. ${err}`)
}

{%- else %}
// Render chart(s) for two traits

const trait_label_1 = {{ label_string_units(data.trait_names[0], report['trait_1']['units']) }};
const trait_label_2 = {{ label_string_units(data.trait_names[1], report['trait_2']['units']) }};

try {
    render_scatterplot_histograms('#phenotype-chart', data, {
        hist_height:   60,
        width:         800,
        height:        800,
        fill_color:    '#0719BC',
        bin_width:     0.2,
        x_label:       `${trait_label_1}`,
        y_label:       `${trait_label_2}`,
        opacity:       0.5,
        opacity_hover: 1,
        tooltip_id:    'tooltip-double-scatterplot',
        tooltip_template: (d, labels) => `
            <p class="tooltip-head"><b>${d[2]}</b></p>
            <p class="tooltip-body">x = ${d[0]}</p>
            <p class="tooltip-body">y = ${d[1]}</p>
        `,
    });
} catch (err) {
    console.error(`Could not construct scatterplot. ${err}`)
}
{%- endif %}

</script>
<script>
    let fullscreenBrowser = document.getElementById("chartContainer");
</script>

{% endblock %}