{% extends "_layouts/default-nocontainer.html" %}
{% block content %}
{% from "_includes/macros.html" import render_field %}

<div class="container">
  <div class="d-flex justify-content-around flex-wrap mb-5">
      <!-- Description card -->
      <div class="col-10 col-md-8 col-lg-4 mx-auto mt-4 mt-lg-0 mb-5 align-self-center">
          <div class="card p-2 shadow descriptionCard cardBorderBottom">
              <div class="card-body">
                  <p class="card-text">
                      This portal will use your data to perform a genome-wide association mapping. Please enter your data using the format shown in the 
                      <a target="_blank" href="{{ ext_asset('data/nemascan_sample_data.tsv') }}">example data file</a> 
                      and upload the tab separated file below. This process will take your quantitative trait data for the set of strains that you scored and test for 
                      correlations of genotype and phenotype at over 50,000 loci across the <em style="color:red">C. elegans</em> genome.</p>
                      <p>You will be linked to a report for the mapping experiment along 
                      with links to download the data. This mapping portal uses a <a target="_blank" href="{{ nemascan_container_url }}">containerized</a> version 
                      of <a target="_blank" href="{{ nemascan_github_url }}">NemaScan</a> and can only map one quantitative trait at a time.</p>
                    <p>
                      Good luck hunting!
                    </p>
              </div>
          </div>
      </div>
      <!-- /Description Card -->
      <!-- Tool -->
      <div class="col-12 col-sm-10 col-md-8 col-lg-6 mx-auto mb-5">
        <div class="card border-0 shadow text-center">
          <!-- Tab Menu -->
          <nav>
            <div class="nav nav-tabs text-bg-light p-1 pb-0" id="nav-tab" role="tablist">
              <button class="nav-link active" id="nav-home-tab" data-bs-toggle="tab" data-bs-target="#nav-home" type="button" role="tab" aria-controls="nav-home" aria-selected="true">New</button>
              <button class="nav-link" id="nav-linkOne-tab" data-bs-toggle="tab" data-bs-target="#nav-linkOne" type="button" role="tab" aria-controls="nav-linkOne" aria-selected="false">Sample Report</button>
              <button class="nav-link" id="nav-linkTwo-tab" type="button" role="tab" aria-controls="nav-linkTwo" aria-selected="false"><a href="{{ url_for('data_releases.data_releases') }}">Release Notes</a></button>
              <button class="nav-link" id="nav-linkTwo-tab" type="button" role="tab" aria-controls="nav-linkTwo" aria-selected="false"><a href="{{ url_for('genetic_mapping.my_results') }}">My Mapping Results</a></button>
            </div>
          </nav>
          <div class="tab-content m-3" id="nav-tabContent">
             <!-- Tab 1 -->
            <div class="tab-pane fade show active px-1 px-lg-5 py-2 text-start toolContent" id="nav-home" role="tabpanel"
              aria-labelledby="nav-home-tab" tabindex="0">
              <p class="card-text">
              <h2 class="mb-4 text-center">New Mapping</h2>
              <!-- UPLOAD FORM -->
              <form id="form-submit" class="form form-inline" enctype="multipart/form-data">
                <div class="mb-4">
                  {{ form.csrf_token }}
                  <input hidden name="jwt_csrf_token" value="{{ jwt_csrf_token }}">
                </div>
                <div class='mb-4'>{{ render_field(form.species) }}</div>
                <div class='mb-4'>{{ render_field(form.label, class_="input-margin", placeholder="Enter a name for your mapping, such as the trait.", style="width:100%") }}</div>
                <div class="mb-4">
                  {% call render_field(form.file) %}
                    <!-- Info Popover -->
                    <a class="btn btn-secondary rounded-circle infoButton" role="button" tabindex="0" data-bs-toggle="popover"
                      data-bs-trigger="focus" data-bs-title="More information"
                      data-bs-content="Enter your data using the form shown in the example data file and upload as a TSV here."><i
                        class="bi bi-info lh-1" aria-hidden="true"></i></a>
                    <!-- /Info Popover -->
                  {% endcall %}
                </div>
                <div class="d-grid mb-4">
                  <button type="submit" id="submit-btn" class="btn btn-secondary text-light">
                    Submit
                  </button>
                  <!-- Modal - display on submit instead of going to new page -->
                  <div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h1 class="modal-title fs-5" id="infoModalLabel">Thank You</h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                              <ul>
                                <li>Your report will be complete in about 2-5 hours</li>
                                <li>You will receive an email when your report is complete</li>
                                <li>You may also check <a href="{{ url_for('genetic_mapping.my_results') }}">My Results</a> for updates.</li>
                              </ul>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
              </form>
              <!-- /UPLOAD FORM -->
              {%- include "_includes/ignore-cache-checkbox.html" %}
              </p>
            </div>
            <!-- Tab 2 -->
            <div class="tab-pane fade text-start px-5 py-2 toolContent" id="nav-linkOne" role="tabpanel"
                aria-labelledby="nav-linkOne-tab" tabindex="0">
                <p class="card-text">
                <h2 class="mb-4 text-center">Sample Report</h2>
                <p>You may download a copy of the sample report here.</p>
                <div class="d-grid mt-3">
                  <a class="btn btn-secondary text-light" role="button" href="#">Download Sample Report</a>
                </div>
                </p>
            </div>
          </div>
          <!-- /Tab Menu -->
    </div>
      </div>

      <!-- /Tool -->
      </div> <!-- /Flex -->
</div> <!-- /Container -->

{% endblock %}


{% block script %}
{% from "_scripts/submit-job.js" import def_submit_job %}
{% from "_includes/macros.html" import update_species_field %}
<script>

{{ def_submit_job('genetic_mapping') }}


function disableButton() {
  const btn = document.getElementById('submit-btn');
  btn.disabled = true;
  btn.innerText = 'Submitting...'
}

function enableButton() {
  const btn = document.getElementById('submit-btn');
  btn.disabled  = false;
  btn.innerText = 'Submit';
}

function resetForm() {
  document.getElementById('form-submit').reset();
  const selector = document.getElementById("{{ form.species.elementId }}");
  selector.value = '';
  {{ update_species_field('selector') }}
  enableButton();
}

// Submit result
$("#form-submit").on("submit", function(e) {
  e.preventDefault();
  disableButton();

  // Get form data
  const data = new FormData($('form#form-submit')[0]);

  submit_job(data, '#infoModal')
    .done((result) => {
      // Reset the form after a successful (non-error) submission
      resetForm();
    })
});

</script>

{% endblock %}